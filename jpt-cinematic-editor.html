<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustPlayTogether 電影氛圍編輯器</title>
    <style>
        /* 頁面基礎樣式 (黑色系) */
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --accent: #4a90e2;
            --border: #333;
        }

        body {
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h2 {
            margin-bottom: 20px;
            font-weight: 300;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
        }

        /* 佈局容器 */
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            width: 100%;
            max-width: 1200px;
        }

        /* 左側控制面板 */
        .controls {
            flex: 1;
            min-width: 320px;
            max-width: 400px;
            background: var(--panel-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            height: fit-content;
        }

        /* 右側預覽區 */
        .preview {
            flex: 2;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        /* 表單元素 */
        .group {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }
        .group:last-child { border-bottom: none; }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-sub);
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* 檔案上傳按鈕美化 */
        input[type="file"] {
            width: 100%;
            padding: 8px;
            background: #2a2a2a;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: white;
        }

        select {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid var(--border);
            color: white;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* Radio 按鈕樣式 */
        .radio-options {
            display: flex;
            gap: 15px;
        }
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            background: #2a2a2a;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border);
            transition: 0.2s;
        }
        .radio-label:hover { background: #333; }
        .radio-label input { margin-right: 8px; }

        /* 下載按鈕 */
        .btn-download {
            width: 100%;
            padding: 15px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-download:hover {
            background: #357abd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }

        /* 畫布 Canvas */
        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #444;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            /* 透明背景格線 */
            background-image:
                linear-gradient(45deg, #222 25%, transparent 25%),
                linear-gradient(-45deg, #222 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #222 75%),
                linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .tips {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>

    <h2>JustPlayTogether 電影氛圍編輯器</h2>

    <div class="container">
        <div class="controls">
            <div class="group">
                <label>1. 選擇遊戲截圖 (底圖)</label>
                <input type="file" id="uploadImg" accept="image/*">
            </div>

            <div class="group">
                <label>2. 裁切比例 (電影黑邊)</label>
                <div class="radio-options">
                    <label class="radio-label">
                        <input type="radio" name="ratio" value="16:9" checked> 16:9 (全螢幕)
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="ratio" value="2.35:1"> 2.35:1 (電影黑邊)
                    </label>
                </div>
                <div class="tips">* 2.35:1 會自動添加上下黑邊遮罩</div>
            </div>

            <div class="group">
                <label>3. 上傳浮水印 (PNG)</label>
                <input type="file" id="uploadLogo" accept="image/png">
                <div class="tips">* 建議使用背景透明的 PNG 檔</div>
            </div>

            <div class="group">
                <label>4. 浮水印大小</label>
                <select id="logoSize">
                    <option value="0.10">小 (寬度 10%)</option>
                    <option value="0.20" selected>中 (寬度 20%)</option>
                    <option value="0.30">大 (寬度 30%)</option>
                </select>
            </div>

            <div class="group">
                <label>5. 浮水印位置</label>
                <select id="logoPos">
                    <option value="lb" selected>左下角 (Left Bottom)</option>
                    <option value="rb">右下角 (Right Bottom)</option>
                    <option value="lt">左上角 (Left Top)</option>
                    <option value="rt">右上角 (Right Top)</option>
                </select>
                <div class="tips">* 系統會確保浮水印不被黑邊蓋住</div>
            </div>

            <button class="btn-download" onclick="downloadResult()">
                下載圖片 (Download)
            </button>
        </div>

        <div class="preview">
            <canvas id="editorCanvas"></canvas>
            <p id="statusMsg" style="margin-top: 10px; color: #666;">等待圖片上傳...</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        let imgObj = null;
        let logoObj = null;

        // 監聽所有操作
        document.getElementById('uploadImg').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                imgObj = new Image();
                imgObj.onload = function() {
                    render();
                    document.getElementById('statusMsg').innerText = `原始解析度: ${imgObj.width} x ${imgObj.height}`;
                };
                imgObj.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('uploadLogo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                logoObj = new Image();
                logoObj.onload = render;
                logoObj.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });

        const inputs = ['ratio', 'logoSize', 'logoPos'];
        // 為 Radio buttons 綁定事件
        document.querySelectorAll('input[name="ratio"]').forEach(el => {
            el.addEventListener('change', render);
        });
        // 為 Selects 綁定事件
        document.getElementById('logoSize').addEventListener('change', render);
        document.getElementById('logoPos').addEventListener('change', render);

        function render() {
            if (!imgObj) return;

            // 1. 設定畫布大小：固定為 16:9 的比例 (基於原圖寬度)
            // 這樣可以保證輸出始終是標準螢幕比例
            const w = imgObj.width;
            const h = Math.round(w * 9 / 16);
            canvas.width = w;
            canvas.height = h;

            // 清除背景 (預設黑色)
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, w, h);

            // 2. 處理圖片裁切與繪製
            // 判斷當前選擇的模式
            const mode = document.querySelector('input[name="ratio"]:checked').value;
            let viewHeight = h; // 可視區域高度
            let blackBarH = 0;  // 黑邊高度

            if (mode === "2.35:1") {
                // 電影模式：中間的可視高度變小
                viewHeight = Math.round(w / 2.35);
                blackBarH = (h - viewHeight) / 2;
            }

            // 繪製底圖 (Object-Fit: Cover)
            // 我們將圖片繪製在中間的 viewHeight 區域，多餘的自動裁切
            drawCover(imgObj, 0, blackBarH, w, viewHeight);

            // 確保黑邊是純黑的 (再次覆蓋上下，修整邊緣)
            if (blackBarH > 0) {
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, w, blackBarH); // 上黑邊
                ctx.fillRect(0, h - blackBarH, w, blackBarH); // 下黑邊
            }

            // 3. 繪製浮水印
            if (logoObj) {
                const scale = parseFloat(document.getElementById('logoSize').value);
                const logoW = w * scale;
                const logoH = logoObj.height * (logoW / logoObj.width);
                
                // 設定邊距
                const padding = w * 0.02; // 寬度的 2%

                let lx, ly;
                const pos = document.getElementById('logoPos').value;

                // X 軸位置
                if (pos.includes('l')) lx = padding; // 左
                else lx = w - logoW - padding;       // 右

                // Y 軸位置 (關鍵：要避開黑邊)
                // 上方位置 = 上黑邊高度 + padding
                // 下方位置 = 總高度 - 下黑邊高度 - Logo高度 - padding
                if (pos.includes('t')) { // Top
                    ly = blackBarH + padding;
                } else { // Bottom
                    ly = h - blackBarH - logoH - padding;
                }

                ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.shadowBlur = 8;
                ctx.drawImage(logoObj, lx, ly, logoW, logoH);
                ctx.shadowBlur = 0;
            }
        }

        // 輔助功能：模擬 CSS 的 background-size: cover
        function drawCover(img, x, y, w, h) {
            ctx.save();
            ctx.beginPath();
            ctx.rect(x, y, w, h);
            ctx.clip(); // 限制繪圖區域

            const imgRatio = img.width / img.height;
            const targetRatio = w / h;
            let renderW, renderH, renderX, renderY;

            if (imgRatio > targetRatio) {
                // 圖片比較寬 -> 以高度為基準，裁切左右
                renderH = h;
                renderW = h * imgRatio;
                renderY = 0;
                renderX = (w - renderW) / 2;
            } else {
                // 圖片比較高 -> 以寬度為基準，裁切上下
                renderW = w;
                renderH = w / imgRatio;
                renderX = 0;
                renderY = (h - renderH) / 2;
            }

            // 注意：這裡的繪製座標要加上原本的位移 x, y
            ctx.drawImage(img, x + renderX, y + renderY, renderW, renderH);
            ctx.restore();
        }

        function downloadResult() {
            if (!imgObj) {
                alert("還沒有上傳圖片喔！");
                return;
            }
            const link = document.createElement('a');
            const time = new Date().toISOString().slice(0,19).replace(/[-T:]/g,"");
            link.download = `FF14_Cinematic_${time}.png`;
            link.href = canvas.toDataURL("image/png", 1.0); // 最高品質
            link.click();
        }
    </script>
</body>
</html>