<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JustPlayTogether 電影氛圍編輯器</title>
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <header>
      <h1>JustPlayTogether 電影氛圍編輯器</h1>
    </header>

    <div class="container">
      <div class="controls">
        <div class="group">
          <label>1. 上傳截圖</label>
          <input type="file" id="uploadImg" accept="image/*" />
          <div class="tips">
            僅支援 JPG, PNG。匯入後可直接在右側畫布「拖曳圖片」調整位置。
          </div>
        </div>

        <div class="group">
          <label>2. 選擇比例</label>
          <div class="radio-group">
            <label class="radio-btn">
              <input type="radio" name="ratio" value="16:9" checked />
              <span>16:9 標準</span>
            </label>
            <label class="radio-btn">
              <input type="radio" name="ratio" value="2.35:1" />
              <span>2.35:1 電影</span>
            </label>
          </div>
          <div class="tips" style="color: #888">* 建議使用電影模式</div>
        </div>

        <div class="group">
          <label>3. 選擇浮水印樣式</label>
          <div class="radio-group">
            <label class="radio-btn">
              <input
                type="radio"
                name="logoStyle"
                value="assets\logo\logo1.png"
                checked
              />
              <span>黑色樣式</span>
            </label>
            <label class="radio-btn">
              <input
                type="radio"
                name="logoStyle"
                value="assets\logo\logo2.png"
              />
              <span>白色樣式</span>
            </label>
          </div>
          <div class="tips" style="color: #888">
            * 若圖片場景較深色，可使用白色樣式
          </div>
        </div>

        <div class="group">
          <label>4. 浮水印調整</label>
          <div style="display: flex; gap: 10px; margin-bottom: 10px">
            <select id="logoSize">
              <option value="0.30">小 (10%)</option>
              <option value="0.40" selected>中 (20%)</option>
              <option value="0.50">大 (30%)</option>
            </select>
          </div>
          <select id="logoPos">
            <option value="lb" selected>左下角 (Left Bottom)</option>
            <option value="rb">右下角 (Right Bottom)</option>
            <option value="lt">左上角 (Left Top)</option>
            <option value="rt">右上角 (Right Top)</option>
          </select>
        </div>

        <button class="btn-download" onclick="downloadResult()">
          下載圖片
        </button>
      </div>

      <div class="preview">
        <canvas id="editorCanvas"></canvas>
        <p
          id="statusMsg"
          style="margin-top: 15px; color: #666; font-size: 0.9rem"
        >
          等待圖片匯入...
        </p>
      </div>
    </div>

    <footer>&copy; 2025 JustPlayTogether. All rights reserved.</footer>

    <script>
      const canvas = document.getElementById("editorCanvas");
      const ctx = canvas.getContext("2d");

      // 狀態變數
      let imgObj = null;
      let logoObj = null;
      let currentLogoSrc = "assets/logo/logo1.png"; // 預設 Logo

      // 拖曳相關變數
      let isDragging = false;
      let startX, startY;
      let panX = 0; // 圖片水平位移
      let panY = 0; // 圖片垂直位移
      // 限制拖曳範圍用
      let minPanX, maxPanX, minPanY, maxPanY;

      // --- 初始化事件監聽 ---

      // 1. 圖片上傳
      document
        .getElementById("uploadImg")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (evt) {
            imgObj = new Image();
            imgObj.onload = function () {
              // 重置拖曳位置到正中間
              panX = 0;
              panY = 0;
              render();
              document.getElementById(
                "statusMsg"
              ).innerText = `解析度: ${imgObj.width} x ${imgObj.height} | 提示：按住畫面可拖曳圖片位置`;
            };
            imgObj.src = evt.target.result;
          };
          reader.readAsDataURL(file);
        });

      // 2. 切換 Logo 樣式 (讀取本地檔案)
      document.querySelectorAll('input[name="logoStyle"]').forEach((el) => {
        el.addEventListener("change", (e) => {
          currentLogoSrc = e.target.value;
          loadLogo();
        });
      });

      function loadLogo() {
        logoObj = new Image();
        logoObj.onload = render;
        logoObj.onerror = function () {
          // 如果找不到圖片，就不顯示 Logo，避免報錯卡死
          logoObj = null;
          console.warn(
            "找不到 Logo 檔案，請確認 logo1.png 或 logo2.png 是否存在"
          );
          render();
        };
        logoObj.src = currentLogoSrc;
      }

      // 3. 其他控制項變化
      document
        .querySelectorAll('input[name="ratio"]')
        .forEach((el) => el.addEventListener("change", render));
      document.getElementById("logoSize").addEventListener("change", render);
      document.getElementById("logoPos").addEventListener("change", render);

      // --- 拖曳功能實作 ---
      canvas.addEventListener("mousedown", (e) => {
        if (!imgObj) return;
        isDragging = true;
        startX = e.offsetX;
        startY = e.offsetY;
        canvas.style.cursor = "grabbing";
      });

      canvas.addEventListener("mousemove", (e) => {
        if (!isDragging || !imgObj) return;

        // 計算滑鼠移動距離
        const dx = e.offsetX - startX;
        const dy = e.offsetY - startY;

        // 更新位移
        panX += dx;
        panY += dy;

        // 更新起始點
        startX = e.offsetX;
        startY = e.offsetY;

        render();
      });

      window.addEventListener("mouseup", () => {
        if (isDragging) {
          isDragging = false;
          canvas.style.cursor = "grab";
        }
      });

      // --- 核心渲染函式 ---
      function render() {
        if (!imgObj) {
          // 尚未上傳圖片時，畫一個空的黑色背景
          canvas.width = 800;
          canvas.height = 450;
          ctx.fillStyle = "#111";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#333";
          ctx.font = "20px Arial";
          ctx.textAlign = "center";
          ctx.fillText("請上傳圖片", 400, 225);
          return;
        }

        // 1. 設定畫布尺寸 (固定 16:9 基底)
        const w = imgObj.width;
        const h = Math.round((w * 9) / 16);
        canvas.width = w;
        canvas.height = h;

        // 2. 計算模式與遮罩
        const mode = document.querySelector(
          'input[name="ratio"]:checked'
        ).value;
        let viewHeight = h;
        let blackBarH = 0;

        if (mode === "2.35:1") {
          viewHeight = Math.round(w / 2.35);
          blackBarH = (h - viewHeight) / 2;
        }

        // 3. 計算圖片縮放與繪製位置 (Cover 邏輯 + 拖曳偏移)
        const imgRatio = imgObj.width / imgObj.height;
        // 這裡的 targetRatio 我們參考的是「可視區域」，但在拖曳邏輯上，我們比較簡單的做法是
        // 先讓圖片縮放到「至少填滿寬度」或「至少填滿高度」，然後允許使用者移動

        // 我們採用：以寬度填滿為優先，若圖片不夠高則放大到高度填滿
        let renderW = w;
        let renderH = w / imgRatio;

        if (renderH < viewHeight) {
          // 如果縮放後的圖片高度比可視區還小，那就要改成「依高度填滿」
          renderH = viewHeight;
          renderW = renderH * imgRatio;
        }

        // 計算初始置中位置 (當 panX, panY 為 0 時)
        const initialX = (w - renderW) / 2;
        const initialY = blackBarH + (viewHeight - renderH) / 2;

        // --- 限制拖曳範圍 (Constraint) ---
        // 邏輯：圖片邊緣不能跑進可視區內部 (不能露出背景黑底)
        // X軸限制
        // 最左邊：renderW 右側剛好貼齊畫布右側 -> panX + initialX + renderW >= w
        // 最右邊：renderW 左側剛好貼齊畫布左側 -> panX + initialX <= 0

        // 簡化計算：
        // 當前繪製的實際 X = initialX + panX
        // 當前繪製的實際 Y = initialY + panY

        // 修正 Pan 值以確保不留白
        const currentX = initialX + panX;
        const currentY = initialY + panY;

        // X 軸邊界檢查
        if (currentX > 0) panX = -initialX; // 不能往右拉過頭
        if (currentX + renderW < w) panX = w - renderW - initialX; // 不能往左拉過頭

        // Y 軸邊界檢查 (需考慮上下黑邊)
        // 頂部邊界：圖片頂部不能低於上黑邊 (currentY <= blackBarH)
        // 底部邊界：圖片底部不能高於下黑邊 (currentY + renderH >= h - blackBarH)

        const checkedY = initialY + panY;
        if (checkedY > blackBarH) panY = blackBarH - initialY;
        if (checkedY + renderH < h - blackBarH)
          panY = h - blackBarH - renderH - initialY;

        // 4. 繪製圖片
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, w, h); // 清空背景

        // 繪製
        ctx.drawImage(
          imgObj,
          initialX + panX,
          initialY + panY,
          renderW,
          renderH
        );

        // 5. 繪製黑邊 (蓋在圖片上面，這樣拖曳時圖片會像是「滑進」黑邊裡)
        if (blackBarH > 0) {
          ctx.fillStyle = "black";
          ctx.fillRect(0, 0, w, blackBarH); // 上
          ctx.fillRect(0, h - blackBarH, w, blackBarH); // 下
        }

        // 6. 繪製 Logo
        if (logoObj) {
          const scale = parseFloat(document.getElementById("logoSize").value);
          const logoW = w * scale;
          const logoH = logoObj.height * (logoW / logoObj.width);
          const padding = w * 0.02;

          let lx, ly;
          const pos = document.getElementById("logoPos").value;

          if (pos.includes("l")) lx = padding;
          else lx = w - logoW - padding;

          if (pos.includes("t")) {
            ly = blackBarH + padding;
          } else {
            ly = h - blackBarH - logoH - padding;
          }

          ctx.shadowColor = "rgba(0,0,0,0.5)";
          ctx.shadowBlur = 8;
          ctx.drawImage(logoObj, lx, ly, logoW, logoH);
          ctx.shadowBlur = 0;
        }
      }

      function downloadResult() {
        if (!imgObj) {
          alert("請先上傳圖片");
          return;
        }
        const link = document.createElement("a");
        const time = new Date()
          .toISOString()
          .slice(0, 19)
          .replace(/[-T:]/g, "");
        link.download = `JustPlayTogether_${time}.png`;
        link.href = canvas.toDataURL("image/png", 1.0);
        link.click();
      }

      // 頁面載入時嘗試載入一次預設 Logo
      window.onload = loadLogo;
    </script>
  </body>
</html>
